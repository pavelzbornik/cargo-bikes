# Story 1.4: Projection Script (Database -> MD files)

## Status

Draft

## Story

**As a** Data Engineer,
**I want** a script that updates the Markdown files based on the data in the SQLite database,
**so that** the files reflect the enriched, canonical data.

## Acceptance Criteria

1. A Python script (`scripts/database/project.py`) is created.
2. The script reads data for one or more bikes from the `vault.db`.
3. For each bike record, it correctly locates the corresponding `.md` file in `vault/notes/`.
4. The script **completely replaces the YAML frontmatter** in the file with an updated version generated from the database record.
5. The script generates a Markdown table containing the bike's key specifications from the database.
6. The script **replaces only the content within the `<!-- BIKE_SPECS_TABLE_START -->` and `<!-- BIKE_SPECS_TABLE_END -->` markers** with the newly generated specifications table.
7. **CRITICAL**: All other Markdown content in the file body—outside of the specified comment-fenced block—is preserved exactly as it was, without any modification.
8. Unit tests are created to verify that manual content is preserved while machine-managed sections are correctly updated.

## Tasks / Subtasks

- [ ] Task 1: Create the new script file: `scripts/database/project.py`. (AC: 1)
- [ ] Task 2: Implement logic to connect to the SQLite database and query for bike records. (AC: 2)
- [ ] Task 3: Implement logic to parse an existing `.md` file, safely separating the YAML frontmatter, the content inside the `BIKE_SPECS_TABLE` block, and all other "manual" content. (AC: 7)
- [ ] Task 4: Implement a function to generate a new YAML frontmatter string from a bike database record. (AC: 4)
- [ ] Task 5: Implement a function to generate a new Markdown specifications table string from a bike database record. (AC: 5)
- [ ] Task 6: Implement the file reconstruction logic. This should combine the new frontmatter, the preserved manual content, the new specs table within its markers, and any other preserved content in the correct order. (AC: 6, 7)
- [ ] Task 7: Implement the logic to overwrite the original `.md` file with the reconstructed content.
- [ ] Task 8: Create a new test file `tests/test_projection.py`. (AC: 8)
  - [ ] Set up a test with a mock `.md` file containing manual content both before and after the `<!-- BIKE_SPECS_TABLE_START -->` block.
  - [ ] Run the projection script against an in-memory database.
  - [ ] Assert that the frontmatter and the specs table block were updated correctly.
  - [ ] **CRITICAL ASSERTION**: Assert that the manual content before and after the block remains completely unchanged.

## Dev Notes

- **CRITICAL CONSTRAINT**: The most important part of this story is the preservation of manual content. Your file I/O logic must be very careful. Read the entire file, identify the machine-managed sections (frontmatter, specs table block), replace them, and then write the reassembled content back. Do not attempt to do an in-place modification. [Source: Story 1.4 AC7]
- **Tech Stack**: Use `SQLAlchemy` to query the database and `PyYAML` to generate the new frontmatter string. [Source: docs/architecture.md#Tech Stack Alignment]
- **Comment Markers**: The script must use the exact HTML comments `<!-- BIKE_SPECS_TABLE_START -->` and `<!-- BIKE_SPECS_TABLE_END -->` to identify the replaceable block in the body. If these markers are not found, the script should not modify the body of the file at all.
- **Testing**: Your tests are the primary safeguard against data loss. The test for AC #8 is non-negotiable and must be thorough. Create a complex mock file with multiple sections, lists, and code blocks to ensure your parsing and reconstruction logic is robust.
- **File Locations**: The script must be at `scripts/database/project.py` and the tests at `tests/test_projection.py`. [Source: docs/architecture.md#Source Tree Integration]

## Change Log

| Date       | Version | Description         | Author |
| ---------- | ------- | ------------------- | ------ |
| 2024-05-22 | 1.0     | Initial story draft | Bob    |
