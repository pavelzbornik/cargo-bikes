# Story 1.3: Hydration Script (MD files -> Database)

## Status

Draft

## Story

**As a** Data Engineer,
**I want** a script that reads YAML frontmatter from all valid Markdown files and populates the SQLite database,
**so that** I can create a structured replica of the vault's content.

## Acceptance Criteria

1. A Python script (`scripts/database/hydrate.py`) is created.
2. The script first runs the custom linter from Story 1.2. If the linter reports any invalid files, the script must abort with an error message and a non-zero exit code.
3. The script recursively scans `vault/notes/` and parses the YAML frontmatter of each valid `.md` file.
4. Data from the frontmatter is inserted or updated (upserted) into the corresponding tables in `vault.db`.
5. The script is idempotent: running it multiple times on an unchanged vault results in the exact same database state without creating duplicate records.
6. The script logs its progress to the console, reporting the total number of files processed and the number of records created or updated.
7. Unit tests are created to verify the hydration logic for bikes, brands, and resellers.

## Tasks / Subtasks

- [ ] Task 1: Create the new script file: `scripts/database/hydrate.py`. (AC: 1)
- [ ] Task 2: Implement a function to call the linter script from Story 1.2. If it returns a non-zero exit code, the hydration script must stop immediately. (AC: 2)
- [ ] Task 3: Establish a database session using SQLAlchemy to connect to the `vault.db` file defined in Story 1.1.
- [ ] Task 4: Implement the file scanning logic to find all `.md` files in `vault/notes/`. (AC: 3)
- [ ] Task 5: For each file, parse the YAML frontmatter. (AC: 3)
- [ ] Task 6: Implement the "upsert" logic for each data type (bike, brand, etc.). (AC: 4, 5)
  - [ ] For each parsed item, query the database to see if a record with the same unique identifier (e.g., brand name + model name for a bike) already exists.
  - [ ] If the record exists, update it with the new data.
  - [ ] If the record does not exist, insert a new one.
- [ ] Task 7: Implement console logging for progress reporting. (AC: 6)
- [ ] Task 8: Create a new test file `tests/test_hydration.py`. (AC: 7)
  - [ ] Set up a temporary, in-memory SQLite database for the tests using the schema from Story 1.1.
  - [ ] Create mock `.md` files with valid frontmatter.
  - [ ] Write a test to verify that running the hydration script correctly populates the in-memory database.
  - [ ] Write a test to verify the idempotency by running the script twice and asserting that the database state is identical and contains no duplicates.

## Dev Notes

- **Dependencies**: This story is critically dependent on the database schema from Story 1.1 and the custom linter from Story 1.2. The hydration script must programmatically call the linter as its first step.
- **Tech Stack**: Use `PyYAML` for parsing frontmatter and `SQLAlchemy` for all database interactions. [Source: docs/architecture.md#Tech Stack Alignment]
- **Idempotency is Key**: The core of this story is the "upsert" logic. Do not simply insert records. You must check for existence first to avoid creating duplicate entries on subsequent runs. This is essential for meeting AC #5.
- **Testing Strategy**: Your tests should not depend on a physical `vault.db` file. Use SQLAlchemy's ability to create an in-memory SQLite database for fast, isolated testing. You will need to programmatically create mock files for the script to read during tests. [Source: docs/architecture.md#Testing Strategy]
- **File Locations**: The script must be at `scripts/database/hydrate.py` and the tests at `tests/test_hydration.py`. [Source: docs/architecture.md#Source Tree Integration]

## Change Log

| Date       | Version | Description         | Author |
| ---------- | ------- | ------------------- | ------ |
| 2024-05-22 | 1.0     | Initial story draft | Bob    |
